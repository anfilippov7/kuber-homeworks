# Домашнее задание к занятию «Управление доступом»### Цель заданияВ тестовой среде Kubernetes нужно предоставить ограниченный доступ пользователю.------### Чеклист готовности к домашнему заданию1. Установлено k8s-решение, например MicroK8S.2. Установленный локальный kubectl.3. Редактор YAML-файлов с подключённым github-репозиторием.------### Инструменты / дополнительные материалы, которые пригодятся для выполнения задания1. [Описание](https://kubernetes.io/docs/reference/access-authn-authz/rbac/) RBAC.2. [Пользователи и авторизация RBAC в Kubernetes](https://habr.com/ru/company/flant/blog/470503/).3. [RBAC with Kubernetes in Minikube](https://medium.com/@HoussemDellai/rbac-with-kubernetes-in-minikube-4deed658ea7b).------### Задание 1. Создайте конфигурацию для подключения пользователя1. Создайте и подпишите SSL-сертификат для подключения к кластеру.2. Настройте конфигурационный файл kubectl для подключения.3. Создайте роли и все необходимые настройки для пользователя.4. Предусмотрите права пользователя. Пользователь может просматривать логи подов и их конфигурацию (`kubectl logs pod <pod_id>`, `kubectl describe pod <pod_id>`).5. Предоставьте манифесты и скриншоты и/или вывод необходимых команд.### Решение 1. Создайте конфигурацию для подключения пользователя1. Создаем и подписываем SSL-сертификат для подключения к кластеру.```aleksander@aleksander-MS-7641:~/kuber-homeworks/2.4$ mkdir certs && cd certsaleksander@aleksander-MS-7641:~/kuber-homeworks/2.4/certs$ openssl genrsa -out aleksander.key 2048aleksander@aleksander-MS-7641:~/kuber-homeworks/2.4/certs$ ls -lитого 4-rw------- 1 aleksander aleksander 1704 апр  4 09:41 aleksander.keyaleksander@aleksander-MS-7641:~/kuber-homeworks/2.4/certs$ openssl req -key aleksander.key -new -out aleksander.csr -subj "/CN=aleksander/O=ops"aleksander@aleksander-MS-7641:~/kuber-homeworks/2.4/certs$ openssl x509 -signkey aleksander.key -in aleksander.csr -req -days 365 -out aleksander.crtCertificate request self-signature oksubject=CN = aleksander, O = opsaleksander@aleksander-MS-7641:~/kuber-homeworks/2.4/certs$ lsaleksander.crt  aleksander.csr  aleksander.keyaleksander@aleksander-MS-7641:~/kuber-homeworks/2.4/certs$ openssl x509 -req -in aleksander.csr -CA aleksander.crt -CAkey aleksander.key -out aleksander.crt -days 3000Certificate request self-signature oksubject=CN = aleksander, O = opsaleksander@aleksander-MS-7641:~/kuber-homeworks/2.4/certs$ lsaleksander.crt  aleksander.csr  aleksander.key```создаем самоподписанный сертификат openssl для нашего CA```aleksander@aleksander-MS-7641:~/kuber-homeworks/2.4/certs$ openssl req -newkey rsa:2048 -nodes -keyout ca.key -x509 -days 3654 -out ca.crt...+...+..+.+...+.....+.+......+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++*........+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++*................+...+....+........+..........+..+...............+....+.....+....+........+....+...+..+.........+.......+.....+.........+......+....+......+...+......+...+......+.....+......+.+..+.......+...+.................+....+..+.........+.+..+.+...............+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++...+.......+...+...+.....+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++*............+.+............+...+..+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++*.........+...........+......+.+..+.+......+.....+...+.......+...+...........+....+......+..+.........+......+...+.+.........+..............+......+............+...+....+...+........+...............+......+.+...+....................................+.....+..........+......+........+.+......+..+...+..........+...............+.........+...........+....+...+........+.......+.....+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++-----You are about to be asked to enter information that will be incorporatedinto your certificate request.What you are about to enter is what is called a Distinguished Name or a DN.There are quite a few fields but you can leave some blankFor some fields there will be a default value,If you enter '.', the field will be left blank.-----Country Name (2 letter code) [AU]:ruState or Province Name (full name) [Some-State]:tkLocality Name (eg, city) []:fgOrganization Name (eg, company) [Internet Widgits Pty Ltd]:fgOrganizational Unit Name (eg, section) []:rtCommon Name (e.g. server FQDN or YOUR name) []:alEmail Address []:der@er.rualeksander@aleksander-MS-7641:~/kuber-homeworks/2.4/certs$ lsca.crt  ca.key  domain.key  test.csr  test.key```Ниже не работает```aleksander@aleksander-MS-7641:~/kuber-homeworks/2.4$ mkdir cert && cd certaleksander@aleksander-MS-7641:~/kuber-homeworks/2.4/cert$ openssl req -newkey rsa:2048 -nodes -keyout ca.key -x509 -days 3654 -out ca.crt..+....+........+.......+.....+.+...+.....+............+...+.........+......+.+...+..+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++*...+.....+.......+..+.+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++*...+.....+.........+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++..+............+......+..............................+...+..+...+.......+..+.......+...+..+....+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++*.+...+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++*........+...+..+.......+..+...+.+.........+...........+.+.....+...+............+.........+....+...+...............+..............+.+..+.......+........+......+.+...........+....+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++-----You are about to be asked to enter information that will be incorporatedinto your certificate request.What you are about to enter is what is called a Distinguished Name or a DN.There are quite a few fields but you can leave some blankFor some fields there will be a default value,If you enter '.', the field will be left blank.-----Country Name (2 letter code) [AU]:ruState or Province Name (full name) [Some-State]:rtLocality Name (eg, city) []:nnOrganization Name (eg, company) [Internet Widgits Pty Ltd]:tkOrganizational Unit Name (eg, section) []:tkCommon Name (e.g. server FQDN or YOUR name) []:aleksanderEmail Address []:aleksander@aleksander-MS-7641:~/kuber-homeworks/2.4/cert$ lsca.crt  ca.keyaleksander@aleksander-MS-7641:~/kuber-homeworks/2.4/cert$ openssl genrsa -out aleksander.key 2048aleksander@aleksander-MS-7641:~/kuber-homeworks/2.4/cert$ lsaleksander.key  ca.crt  ca.keyaleksander@aleksander-MS-7641:~/kuber-homeworks/2.4/cert$ openssl req -new -key aleksander.key -out aleksander.csr -subj "/CN=test/O=ops"aleksander@aleksander-MS-7641:~/kuber-homeworks/2.4/cert$ lsaleksander.csr  aleksander.key  ca.crt  ca.keyaleksander@aleksander-MS-7641:~/kuber-homeworks/2.4/cert$ openssl x509 -req -in aleksander.csr -CA ca.crt -CAkey ca.key -out aleksander.crt -days 3000Certificate request self-signature oksubject=CN = test, O = opsaleksander@aleksander-MS-7641:~/kuber-homeworks/2.4/cert$ kubectl config set-credentials aleksander --client-certificate=aleksander.crt --client-key=aleksander.key --embed-certs=trueerror: open /home/aleksander/.kube/config: permission deniedaleksander@aleksander-MS-7641:~/kuber-homeworks/2.4/cert$ sudo kubectl config set-credentials aleksander --client-certificate=aleksander.crt --client-key=aleksander.key --embed-certs=trueUser "aleksander" set.aleksander@aleksander-MS-7641:~/kuber-homeworks/2.4/cert$ sudo kubectl config set-context aleksander --cluster=docker-desktop --user=aleksanderContext "aleksander" created.aleksander@aleksander-MS-7641:~/kuber-homeworks/2.4/cert$ kubectl config get-contextsCURRENT   NAME       CLUSTER            AUTHINFO   NAMESPACE*         microk8s   microk8s-cluster   admin      aleksander@aleksander-MS-7641:~/kuber-homeworks/2.4/cert$ sudo kubectl config get-contextsCURRENT   NAME         CLUSTER          AUTHINFO     NAMESPACE          aleksander   docker-desktop   aleksander   aleksander@aleksander-MS-7641:~/kuber-homeworks/2.4/cert$ cd ..aleksander@aleksander-MS-7641:~/kuber-homeworks/2.4$ cd src/aleksander@aleksander-MS-7641:~/kuber-homeworks/2.4/src$ kubectl -n aleksander create -f role.yamlError from server (NotFound): error when creating "role.yaml": namespaces "aleksander" not foundaleksander@aleksander-MS-7641:~/kuber-homeworks/2.4/src$ sudo kubectl -n aleksander create -f role.yamlerror: error validating "role.yaml": error validating data: failed to download openapi: Get "http://localhost:8080/openapi/v2?timeout=32s": dial tcp 127.0.0.1:8080: connect: connection refused; if you choose to ignore these errors, turn validation off with --validate=falsealeksander@aleksander-MS-7641:~/kuber-homeworks/2.4/src$ sudo kubectl -n aleksander create -f role.yaml --validate=falseE0404 12:01:54.907675 2452813 memcache.go:265] couldn't get current server API group list: Get "http://localhost:8080/api?timeout=32s": dial tcp 127.0.0.1:8080: connect: connection refusederror: unable to recognize "role.yaml": Get "http://localhost:8080/api?timeout=32s": dial tcp 127.0.0.1:8080: connect: connection refusedaleksander@aleksander-MS-7641:~/kuber-homeworks/2.4/src$ kubectl get podsNo resources found in default namespace.aleksander@aleksander-MS-7641:~/kuber-homeworks/2.4/src$ sudo kubectl get podsE0404 12:02:46.636825 2454472 memcache.go:265] couldn't get current server API group list: Get "http://localhost:8080/api?timeout=32s": dial tcp 127.0.0.1:8080: connect: connection refusedE0404 12:02:46.637046 2454472 memcache.go:265] couldn't get current server API group list: Get "http://localhost:8080/api?timeout=32s": dial tcp 127.0.0.1:8080: connect: connection refusedE0404 12:02:46.638246 2454472 memcache.go:265] couldn't get current server API group list: Get "http://localhost:8080/api?timeout=32s": dial tcp 127.0.0.1:8080: connect: connection refusedE0404 12:02:46.638411 2454472 memcache.go:265] couldn't get current server API group list: Get "http://localhost:8080/api?timeout=32s": dial tcp 127.0.0.1:8080: connect: connection refusedE0404 12:02:46.639814 2454472 memcache.go:265] couldn't get current server API group list: Get "http://localhost:8080/api?timeout=32s": dial tcp 127.0.0.1:8080: connect: connection refusedThe connection to the server localhost:8080 was refused - did you specify the right host or port?```2. Настраиваем конфигурационный файл kubectl для подключения.```aleksander@aleksander-MS-7641:~/kuber-homeworks/2.4/certs$ kubectl config set-credentials aleksander --client-certificate=aleksander.crt --client-key=aleksander.key --embed-certs=trueUser "aleksander" set.aleksander@aleksander-MS-7641:~/kuber-homeworks/2.4/certs$ kubectl config set-context aleksander --cluster=docker-desktop --user=aleksanderContext "aleksander" created.aleksander@aleksander-MS-7641:~/kuber-homeworks/2.4/certs$ kubectl config get-contextsCURRENT   NAME         CLUSTER            AUTHINFO     NAMESPACE          aleksander   docker-desktop     aleksander   *         microk8s     microk8s-cluster   admin        aleksander@aleksander-MS-7641:~/kuber-homeworks/2.4/certs$ kubectl config use-context aleksanderSwitched to context "aleksander".aleksander@aleksander-MS-7641:~/kuber-homeworks/2.4/certs$ kubectl config viewapiVersion: v1clusters:- cluster:    certificate-authority-data: DATA+OMITTED    server: https://192.168.52.107:16443  name: microk8s-clustercontexts:- context:    cluster: docker-desktop    user: aleksander  name: aleksander- context:    cluster: microk8s-cluster    user: admin  name: microk8scurrent-context: aleksanderkind: Configpreferences: {}users:- name: admin  user:    client-certificate-data: DATA+OMITTED    client-key-data: DATA+OMITTED- name: aleksander  user:    client-certificate-data: DATA+OMITTED    client-key-data: DATA+OMITTED```3. Создаем роли и все необходимые настройки для пользователя. - конфигурация роли```apiVersion: rbac.authorization.k8s.io/v1kind: Rolemetadata:  name: pod-desc-logs  namespace: defaultrules:- apiGroups: [""]  resources: ["pods", "pods/log"]  verbs: ["watch", "list", "get"]``` - конфигурация связывание ролей```apiVersion: rbac.authorization.k8s.io/v1kind: RoleBindingmetadata:  name: pod-reader  namespace: defaultsubjects:- kind: User  name: aleksander  apiGroup: rbac.authorization.k8s.ioroleRef:  kind: Role  name: pod-desc-logs  apiGroup: rbac.authorization.k8s.io```------### Правила приёма работы1. Домашняя работа оформляется в своём Git-репозитории в файле README.md. Выполненное домашнее задание пришлите ссылкой на .md-файл в вашем репозитории.2. Файл README.md должен содержать скриншоты вывода необходимых команд `kubectl`, скриншоты результатов.3. Репозиторий должен содержать тексты манифестов или ссылки на них в файле README.md.------